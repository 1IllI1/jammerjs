<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
    <meta name="msapplication-tap-highlight" content="no"/>
    <link rel="stylesheet" href="assets/style.css">
    <title>Hammer.js</title>
</head>
<body>
    <div class="container">
        <div id="hit" class="bg1" style="padding: 30px; height: 200px;">
        </div>

        <pre id="debug" style="overflow:hidden; background: #eee; padding: 15px;"></pre>
        <pre id="debug2" style="overflow:hidden; background: #eee; padding: 15px;"></pre>

        <pre id="log" style="overflow:hidden;"></pre>

        <div id="handtrackjs">
          <video autoplay="autoplay" style="display: none;"></video>
          <canvas></canvas>
          <div>Loading...</div>
        </div>
    </div>
    <script src="../node_modules/hammerjs/hammer.js"></script>
    <script src="../node_modules/handtrackjs/dist/handtrack.min.js"> </script>
    <script src="../dist/index.js"></script>
    <script>

        Object.prototype.toDirString = function() {
            var output = [];
            for(var key in this) {
                if(this.hasOwnProperty(key)) {
                    var value = this[key];
                    if(Array.isArray(value)) {
                        value = "Array("+ value.length +"):"+ value;
                    } else if(value instanceof HTMLElement) {
                        value = value +" ("+ value.outerHTML.substring(0, 50) +"...)";
                    }
                    output.push(key +": "+ value);
                }
            }
            return output.join("\n")
        };

        var el = document.querySelector("#hit");
        var log = document.querySelector("#log");
        var debug = document.querySelector("#debug");

        // el.addEventListener("touchmove", function(ev) {console.log(ev)});


        var mc = new Hammer(el, {inputClass: Hammer.TouchInput});
        mc.get('pinch').set({ enable: true });

        // mc.on("hammer.input", function(ev) {
        //     debug.innerHTML = [ev.srcEvent.type, ev.pointers.length, ev.isFinal, ev.deltaX, ev.deltaY].join("<br>");
        // });
        // mc.on("swipe", function(ev) {
        //     debug.innerHTML = [ev.srcEvent.type, ev.pointers.length, ev.isFinal, ev.deltaX, ev.deltaY].join("<br>");
        // });
        mc.on("pan swipe rotate pinch tap doubletap press", function(ev) {
                el.textContent = ev.type +" "+ el.textContent;
            });

        var video = document.getElementById("handtrackjs").getElementsByTagName("video")[0];
        // video.width = 320
        // video.height = 240
        var canvas = document.getElementById("handtrackjs").getElementsByTagName("canvas")[0];
        const context = canvas.getContext("2d");
        var trackerStatus = document.getElementById("handtrackjs").getElementsByTagName("div")[0];

        // let isVideo = false;



  let model = null;
  let isVideo = false;

  const modelParams = {
    flipHorizontal: true,   // flip e.g for video
    maxNumBoxes: 20,        // maximum number of boxes to detect
    iouThreshold: 0.5,      // ioU threshold for non-max suppression
    scoreThreshold: 0.6,    // confidence threshold for predictions.
  }

  handTrack.load(modelParams).then(lmodel => {
    model = lmodel;
  });

  function startVideo() {
    handTrack.startVideo(video).then(function (status) {
      console.log("video started", status);
      if (status) {
        isVideo = true
        runDetection()
      }
    });
  }

  let lastPredictions = [];

  Simulator.setType('touch');
    Simulator.events.touch.fakeSupport();

  function runDetection() {
    let posX;
    let posY;
    let elements = document.querySelector("#hit");
    let touches;

    model.detect(video).then(predictions => {
      // console.log("Predictions: ", predictions);
      model.renderPredictions(predictions, canvas, context, video);

      if (lastPredictions.length === 0
        && predictions.length > 0) {
        // console.log('start')

        posX = predictions[0].bbox[0];
        posY = predictions[0].bbox[1];
        touches = [{ x: posX, y: posY, target: elements }];
        Simulator.events.touch.trigger(touches, touches[0].target, 'start');

      } else if (predictions.length === 0
        && lastPredictions.length > 0) {
        // console.log('end')

        posX = lastPredictions[0].bbox[0];
        posY = lastPredictions[0].bbox[1];
        touches = [{ x: posX, y: posY, target: elements }];
        Simulator.events.touch.trigger(touches, touches[0].target, 'end');

      } else if (predictions.length > 0) {
        // console.log('moving');

        posX = predictions[0].bbox[0];
        posY = predictions[0].bbox[1];
        touches = [{ x: posX, y: posY, target: elements }];
        Simulator.events.touch.trigger(touches, touches[0].target, 'move');

      }

      lastPredictions = predictions;

      if (isVideo) {
        requestAnimationFrame(runDetection);
      }
    });
  }

  startVideo();


    </script>
</body>
</html>
